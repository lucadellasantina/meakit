<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fix_lines</title>
  <meta name="keywords" content="fix_lines">
  <meta name="description" content="FIX_LINES  Improves the line style of eps files generated by print">
  <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
    <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # Otherbox --><!-- menu.html export_fig -->
<h1>fix_lines
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>FIX_LINES  Improves the line style of eps files generated by print</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function fix_lines(fname, fname2) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../brain.png)"><pre class="comment">FIX_LINES  Improves the line style of eps files generated by print

 Examples:
   fix_lines fname
   fix_lines fname fname2

 This function improves the style of lines in eps files generated by
 MATLAB's print function, making them more similar to those seen on
 screen. Grid lines are also changed from a dashed style to a dotted
 style, for greater differentiation from dashed lines.
 
 The function also places embedded fonts after the postscript header, in
 versions of MATLAB which place the fonts first (R2006b and earlier), in
 order to allow programs such as Ghostscript to find the bounding box
 information.

 IN:
   fname - Name or path of source eps file.
   fname2 - Name or path of destination eps file. Default: same as fname.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../brain.png)">
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../Otherbox/m2html/private/strtok.html" class="code" title="function [token, remainder, quotient] = strtok(string, delimiters)">strtok</a>	Modified version of STRTOK to also return the quotient</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="print2eps.html" class="code" title="function print2eps(name, fig, varargin)">print2eps</a>	PRINT2EPS  Prints figures to eps with improved line styles</li></ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../brain.png)"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function fix_lines(fname, fname2)</a>
0002 <span class="comment">%FIX_LINES  Improves the line style of eps files generated by print</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Examples:</span>
0005 <span class="comment">%   fix_lines fname</span>
0006 <span class="comment">%   fix_lines fname fname2</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% This function improves the style of lines in eps files generated by</span>
0009 <span class="comment">% MATLAB's print function, making them more similar to those seen on</span>
0010 <span class="comment">% screen. Grid lines are also changed from a dashed style to a dotted</span>
0011 <span class="comment">% style, for greater differentiation from dashed lines.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% The function also places embedded fonts after the postscript header, in</span>
0014 <span class="comment">% versions of MATLAB which place the fonts first (R2006b and earlier), in</span>
0015 <span class="comment">% order to allow programs such as Ghostscript to find the bounding box</span>
0016 <span class="comment">% information.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% IN:</span>
0019 <span class="comment">%   fname - Name or path of source eps file.</span>
0020 <span class="comment">%   fname2 - Name or path of destination eps file. Default: same as fname.</span>
0021 
0022 <span class="comment">% Copyright: (C) Oliver Woodford, 2008-2010</span>
0023 
0024 <span class="comment">% The idea of editing the EPS file to change line styles comes from Jiro</span>
0025 <span class="comment">% Doke's FIXPSLINESTYLE (fex id: 17928)</span>
0026 <span class="comment">% The idea of changing dash length with line width came from comments on</span>
0027 <span class="comment">% fex id: 5743, but the implementation is mine :)</span>
0028 
0029 <span class="comment">% Thank you to Sylvain Favrot for bringing the embedded font/bounding box</span>
0030 <span class="comment">% interaction in older versions of MATLAB to my attention.</span>
0031 <span class="comment">% Thank you to D Ko for bringing an error with eps files with tiff previews</span>
0032 <span class="comment">% to my attention.</span>
0033 <span class="comment">% Thank you to Laurence K for suggesting the check to see if the file was</span>
0034 <span class="comment">% opened.</span>
0035 
0036 <span class="comment">% Read in the file</span>
0037 fh = fopen(fname, <span class="string">'r'</span>);
0038 <span class="keyword">if</span> fh == -1
0039     error(<span class="string">'File %s not found.'</span>, fname);
0040 <span class="keyword">end</span>
0041 <span class="keyword">try</span>
0042     fstrm = fread(fh, <span class="string">'*char'</span>)';
0043 <span class="keyword">catch</span>
0044     fclose(fh);
0045     rethrow(lasterror);
0046 <span class="keyword">end</span>
0047 fclose(fh);
0048 
0049 <span class="comment">% Move any embedded fonts after the postscript header</span>
0050 <span class="keyword">if</span> strcmp(fstrm(1:15), <span class="string">'%!PS-AdobeFont-'</span>)
0051     <span class="comment">% Find the start and end of the header</span>
0052     ind = regexp(fstrm, <span class="string">'[\n\r]%!PS-Adobe-'</span>);
0053     [ind2 ind2] = regexp(fstrm, <span class="string">'[\n\r]%%EndComments[\n\r]+'</span>);
0054     <span class="comment">% Put the header first</span>
0055     <span class="keyword">if</span> ~isempty(ind) &amp;&amp; ~isempty(ind2) &amp;&amp; ind(1) &lt; ind2(1)
0056         fstrm = fstrm([ind(1)+1:ind2(1) 1:ind(1) ind2(1)+1:end]);
0057     <span class="keyword">end</span>
0058 <span class="keyword">end</span>
0059 
0060 <span class="comment">% Make sure all line width commands come before the line style definitions,</span>
0061 <span class="comment">% so that dash lengths can be based on the correct widths</span>
0062 <span class="comment">% Find all line style sections</span>
0063 ind = [regexp(fstrm, <span class="string">'[\n\r]SO[\n\r]'</span>),<span class="keyword">...</span><span class="comment"> % This needs to be here even though it doesn't have dots/dashes!</span>
0064        regexp(fstrm, <span class="string">'[\n\r]DO[\n\r]'</span>),<span class="keyword">...</span>
0065        regexp(fstrm, <span class="string">'[\n\r]DA[\n\r]'</span>),<span class="keyword">...</span>
0066        regexp(fstrm, <span class="string">'[\n\r]DD[\n\r]'</span>)];
0067 ind = sort(ind);
0068 <span class="comment">% Find line width commands</span>
0069 [ind2 ind3] = regexp(fstrm, <span class="string">'[\n\r]\d* w[\n\r]'</span>);
0070 <span class="comment">% Go through each line style section and swap with any line width commands</span>
0071 <span class="comment">% near by</span>
0072 b = 1;
0073 m = numel(ind);
0074 n = numel(ind2);
0075 <span class="keyword">for</span> a = 1:m
0076     <span class="comment">% Go forwards width commands until we pass the current line style</span>
0077     <span class="keyword">while</span> b &lt;= n &amp;&amp; ind2(b) &lt; ind(a)
0078         b = b + 1;
0079     <span class="keyword">end</span>
0080     <span class="keyword">if</span> b &gt; n
0081         <span class="comment">% No more width commands</span>
0082         <span class="keyword">break</span>;
0083     <span class="keyword">end</span>
0084     <span class="comment">% Check we haven't gone past another line style (including SO!)</span>
0085     <span class="keyword">if</span> a &lt; m &amp;&amp; ind2(b) &gt; ind(a+1)
0086         <span class="keyword">continue</span>;
0087     <span class="keyword">end</span>
0088     <span class="comment">% Are the commands close enough to be confident we can swap them?</span>
0089     <span class="keyword">if</span> (ind2(b) - ind(a)) &gt; 8
0090         <span class="keyword">continue</span>;
0091     <span class="keyword">end</span>
0092     <span class="comment">% Move the line style command below the line width command</span>
0093     fstrm(ind(a)+1:ind3(b)) = [fstrm(ind(a)+4:ind3(b)) fstrm(ind(a)+1:ind(a)+3)];
0094     b = b + 1;
0095 <span class="keyword">end</span>
0096 
0097 <span class="comment">% Find any grid line definitions and change to GR format</span>
0098 <span class="comment">% Find the DO sections again as they may have moved</span>
0099 ind = int32(regexp(fstrm, <span class="string">'[\n\r]DO[\n\r]'</span>));
0100 <span class="keyword">if</span> ~isempty(ind)
0101     <span class="comment">% Find all occurrences of what are believed to be axes and grid lines</span>
0102     ind2 = int32(regexp(fstrm, <span class="string">'[\n\r] *\d* *\d* *mt *\d* *\d* *L[\n\r]'</span>));
0103     <span class="keyword">if</span> ~isempty(ind2)
0104         <span class="comment">% Now see which DO sections come just before axes and grid lines</span>
0105         ind2 = repmat(ind2', [1 numel(ind)]) - repmat(ind, [numel(ind2) 1]);
0106         ind2 = any(ind2 &gt; 0 &amp; ind2 &lt; 12); <span class="comment">% 12 chars seems about right</span>
0107         ind = ind(ind2);
0108         <span class="comment">% Change any regions we believe to be grid lines to GR</span>
0109         fstrm(ind+1) = <span class="string">'G'</span>;
0110         fstrm(ind+2) = <span class="string">'R'</span>;
0111     <span class="keyword">end</span>
0112 <span class="keyword">end</span>
0113 
0114 <span class="comment">% Isolate line style definition section</span>
0115 first_sec = findstr(fstrm, <span class="string">'% line types:'</span>);
0116 [second_sec remaining] = <a href="../../Otherbox/m2html/private/strtok.html" class="code" title="function [token, remainder, quotient] = strtok(string, delimiters)">strtok</a>(fstrm(first_sec+1:end), <span class="string">'/'</span>);
0117 [dummy remaining] = <a href="../../Otherbox/m2html/private/strtok.html" class="code" title="function [token, remainder, quotient] = strtok(string, delimiters)">strtok</a>(remaining, <span class="string">'%'</span>);
0118 
0119 <span class="comment">% Define the new styles, including the new GR format</span>
0120 <span class="comment">% Dot and dash lengths have two parts: a constant amount plus a line width</span>
0121 <span class="comment">% variable amount. The constant amount comes after dpi2point, and the</span>
0122 <span class="comment">% variable amount comes after currentlinewidth. If you want to change</span>
0123 <span class="comment">% dot/dash lengths for a one particular line style only, edit the numbers</span>
0124 <span class="comment">% in the /DO (dotted lines), /DA (dashed lines), /DD (dot dash lines) and</span>
0125 <span class="comment">% /GR (grid lines) lines for the style you want to change.</span>
0126 new_style = {<span class="string">'/dom { dpi2point 1 currentlinewidth 0.08 mul add mul mul } bdef'</span>,<span class="keyword">...</span><span class="comment"> % Dot length macro based on line width</span>
0127              <span class="string">'/dam { dpi2point 2 currentlinewidth 0.04 mul add mul mul } bdef'</span>,<span class="keyword">...</span><span class="comment"> % Dash length macro based on line width</span>
0128              <span class="string">'/SO { [] 0 setdash 0 setlinecap } bdef'</span>,<span class="keyword">...</span><span class="comment"> % Solid lines</span>
0129              <span class="string">'/DO { [1 dom 1.2 dom] 0 setdash 0 setlinecap } bdef'</span>,<span class="keyword">...</span><span class="comment"> % Dotted lines</span>
0130              <span class="string">'/DA { [4 dam 1.5 dam] 0 setdash 0 setlinecap } bdef'</span>,<span class="keyword">...</span><span class="comment"> % Dashed lines</span>
0131              <span class="string">'/DD { [1 dom 1.2 dom 4 dam 1.2 dom] 0 setdash 0 setlinecap } bdef'</span>,<span class="keyword">...</span><span class="comment"> % Dot dash lines</span>
0132              <span class="string">'/GR { [0 dpi2point mul 4 dpi2point mul] 0 setdash 1 setlinecap } bdef'</span>}; <span class="comment">% Grid lines - dot spacing remains constant</span>
0133 
0134 <span class="keyword">if</span> nargin &lt; 2
0135     <span class="comment">% Overwrite the input file</span>
0136     fname2 = fname;
0137 <span class="keyword">end</span>
0138 
0139 <span class="comment">% Save the file with the section replaced</span>
0140 fh = fopen(fname2, <span class="string">'w'</span>);
0141 <span class="keyword">if</span> fh == -1
0142     error(<span class="string">'Unable to open %s for writing.'</span>, fname2);
0143 <span class="keyword">end</span>
0144 <span class="keyword">try</span>
0145     fwrite(fh, fstrm(1:first_sec), <span class="string">'char*1'</span>);
0146     fwrite(fh, second_sec, <span class="string">'char*1'</span>);
0147     fprintf(fh, <span class="string">'%s\r'</span>, new_style{:});
0148     fwrite(fh, remaining, <span class="string">'char*1'</span>);
0149 <span class="keyword">catch</span>
0150     fclose(fh);
0151     rethrow(lasterror);
0152 <span class="keyword">end</span>
0153 fclose(fh);
0154 <span class="keyword">return</span></pre></div>
<hr><address>Copyright (C) 2008-2010 Pu Jiangbo @ Britton Chance Center for Biomedical Photonics<br/>Generated on Fri 22-Jun-2012 16:47:48</address>
</body>
</html>